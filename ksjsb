// å¿«æ‰‹æé€Ÿç‰ˆè‡ªåŠ¨ä»»åŠ¡è„šæœ¬ - é€‚ç”¨äºé’é¾™é¢æ¿
// æ›´æ–°æ—¥æœŸ: 2025-07-28
// æ”¯æŒç­¾åˆ°ã€è§‚çœ‹è§†é¢‘ã€å¼€å®ç®±ã€çœ‹å¹¿å‘Šç­‰ä»»åŠ¡
// é›†æˆè‡ªåŠ¨æ¥å£æ›´æ–°å’Œç­¾ååŠŸèƒ½

const $ = new Env('å¿«æ‰‹æé€Ÿç‰ˆ');
const notify = $.isNode() ? require('./sendNotify') : '';
const fs = $.isNode() ? require('fs') : '';
const path = $.isNode() ? require('path') : '';

// é…ç½®ä¿¡æ¯
const config = {
    // å¿«æ‰‹æé€Ÿç‰ˆCookieï¼Œå¯å¡«å…¥å¤šä¸ª
    cookies: [
        '', // ç¬¬ä¸€ä¸ªè´¦å·Cookie
        ''  // ç¬¬äºŒä¸ªè´¦å·Cookieï¼ˆå¯æ·»åŠ æ›´å¤šï¼‰
    ],
    // ä»»åŠ¡é…ç½®
    taskConfig: {
        watchVideoCount: 30,      // è§‚çœ‹è§†é¢‘æ•°é‡
        watchVideoInterval: 5000, // è§‚çœ‹è§†é¢‘é—´éš”(æ¯«ç§’)
        openBoxCount: 5,          // å¼€å®ç®±æ¬¡æ•°
        watchAdCount: 10,         // è§‚çœ‹å¹¿å‘Šæ•°é‡
        minWaitTime: 3000,        // æœ€å°ç­‰å¾…æ—¶é—´(æ¯«ç§’)
        maxWaitTime: 8000         // æœ€å¤§ç­‰å¾…æ—¶é—´(æ¯«ç§’)
    },
    // è‡ªåŠ¨æ›´æ–°é…ç½®
    autoUpdate: {
        enable: true,             // å¯ç”¨è‡ªåŠ¨æ›´æ–°
        checkInterval: 86400000,  // æ£€æŸ¥é—´éš”(æ¯«ç§’)ï¼Œé»˜è®¤1å¤©
        repoUrl: 'https://gitee.com/your-repo/kuaishou-script/raw/main/ks_speed.js', // è„šæœ¬ä»“åº“åœ°å€
        localPath: '/ql/scripts/ks_speed.js'  // æœ¬åœ°è„šæœ¬è·¯å¾„
    },
    // æ¥å£é…ç½®
    apiConfig: {
        baseUrl: 'https://api.kuaishouzt.com',
        version: '10.16.30.31870',
        os: 'android',
        deviceId: 'KS' + Math.random().toString(36).substr(2, 15).toUpperCase()
    }
};

// å…¨å±€å˜é‡
let currentAccount = 0;
let totalPoints = 0;
let todayEarnedPoints = 0;
let isFirstLogin = false;
let apiConfig = config.apiConfig;

// ä¸»å‡½æ•°
async function main() {
    $.log(`å¼€å§‹æ‰§è¡Œå¿«æ‰‹æé€Ÿç‰ˆä»»åŠ¡ï¼Œå…± ${config.cookies.length} ä¸ªè´¦å·`);
    
    // æ£€æŸ¥è„šæœ¬æ›´æ–°
    if (config.autoUpdate.enable) {
        await checkScriptUpdate();
    }
    
    for (let i = 0; i < config.cookies.length; i++) {
        currentAccount = i + 1;
        $.log(`\nå¼€å§‹å¤„ç†ç¬¬ ${currentAccount} ä¸ªè´¦å·`);
        
        if (!config.cookies[i]) {
            $.log(`ç¬¬ ${currentAccount} ä¸ªè´¦å·Cookieä¸ºç©ºï¼Œè·³è¿‡`);
            continue;
        }
        
        await handleAccount(config.cookies[i]);
        await randomWait();
    }
    
    await summary();
    await notifyResult();
    $.done();
}

// å¤„ç†å•ä¸ªè´¦å·
async function handleAccount(cookie) {
    try {
        // ç™»å½•æ£€æŸ¥
        const loginResult = await checkLogin(cookie);
        if (!loginResult.success) {
            $.log(`ç¬¬ ${currentAccount} ä¸ªè´¦å·ç™»å½•å¤±è´¥: ${loginResult.message}`);
            return;
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfo = await getUserInfo(cookie);
        if (!userInfo) {
            $.log(`ç¬¬ ${currentAccount} ä¸ªè´¦å·è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥`);
            return;
        }
        
        $.log(`æ¬¢è¿å›æ¥ï¼Œ${userInfo.nickname}`);
        $.log(`å½“å‰é‡‘å¸: ${userInfo.goldCoins}`);
        totalPoints += parseInt(userInfo.goldCoins);
        
        // æ‰§è¡Œç­¾åˆ°
        const signResult = await doSignIn(cookie);
        if (signResult.success) {
            $.log(`ç­¾åˆ°æˆåŠŸï¼Œè·å¾— ${signResult.reward} é‡‘å¸`);
            todayEarnedPoints += parseInt(signResult.reward);
            isFirstLogin = signResult.isFirstLogin;
        } else {
            $.log(`ç­¾åˆ°å¤±è´¥: ${signResult.message}`);
        }
        
        // è§‚çœ‹è§†é¢‘ä»»åŠ¡
        if (config.taskConfig.watchVideoCount > 0) {
            $.log(`å¼€å§‹æ‰§è¡Œè§‚çœ‹è§†é¢‘ä»»åŠ¡ï¼Œç›®æ ‡ ${config.taskConfig.watchVideoCount} ä¸ª`);
            const watchResult = await watchVideos(cookie, config.taskConfig.watchVideoCount);
            $.log(`è§‚çœ‹è§†é¢‘ä»»åŠ¡å®Œæˆï¼Œå…±è·å¾— ${watchResult} é‡‘å¸`);
            todayEarnedPoints += parseInt(watchResult);
        }
        
        // å¼€å®ç®±ä»»åŠ¡
        if (config.taskConfig.openBoxCount > 0) {
            $.log(`å¼€å§‹æ‰§è¡Œå¼€å®ç®±ä»»åŠ¡ï¼Œç›®æ ‡ ${config.taskConfig.openBoxCount} æ¬¡`);
            const boxResult = await openBoxes(cookie, config.taskConfig.openBoxCount);
            $.log(`å¼€å®ç®±ä»»åŠ¡å®Œæˆï¼Œå…±è·å¾— ${boxResult} é‡‘å¸`);
            todayEarnedPoints += parseInt(boxResult);
        }
        
        // çœ‹å¹¿å‘Šä»»åŠ¡
        if (config.taskConfig.watchAdCount > 0) {
            $.log(`å¼€å§‹æ‰§è¡Œçœ‹å¹¿å‘Šä»»åŠ¡ï¼Œç›®æ ‡ ${config.taskConfig.watchAdCount} ä¸ª`);
            const adResult = await watchAds(cookie, config.taskConfig.watchAdCount);
            $.log(`çœ‹å¹¿å‘Šä»»åŠ¡å®Œæˆï¼Œå…±è·å¾— ${adResult} é‡‘å¸`);
            todayEarnedPoints += parseInt(adResult);
        }
        
        // å…¶ä»–ä»»åŠ¡...
        
    } catch (error) {
        $.log(`å¤„ç†è´¦å·æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
    }
}

// ç™»å½•æ£€æŸ¥
async function checkLogin(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/feed/profile',
            method: 'GET',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1) {
            return { success: true, message: 'ç™»å½•æˆåŠŸ' };
        } else {
            return { success: false, message: response.data.error_msg || 'ç™»å½•å¤±è´¥' };
        }
    } catch (error) {
        return { success: false, message: error.message || 'è¯·æ±‚å¼‚å¸¸' };
    }
}

// è·å–ç”¨æˆ·ä¿¡æ¯
async function getUserInfo(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/user/info',
            method: 'GET',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1 && response.data.user) {
            return {
                nickname: response.data.user.nickname,
                goldCoins: response.data.user.goldCoins || 0
            };
        }
        return null;
    } catch (error) {
        $.log(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`);
        return null;
    }
}

// ç­¾åˆ°
async function doSignIn(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/activity/task/signIn',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1) {
            return {
                success: true,
                reward: response.data.rewardCoins || 0,
                isFirstLogin: response.data.isFirstLogin || false
            };
        } else {
            return {
                success: false,
                message: response.data.error_msg || 'ç­¾åˆ°å¤±è´¥'
            };
        }
    } catch (error) {
        return {
            success: false,
            message: error.message || 'ç­¾åˆ°è¯·æ±‚å¼‚å¸¸'
        };
    }
}

// è§‚çœ‹è§†é¢‘
async function watchVideos(cookie, count) {
    let totalRewards = 0;
    
    for (let i = 1; i <= count; i++) {
        $.log(`æ­£åœ¨è§‚çœ‹ç¬¬ ${i}/${count} ä¸ªè§†é¢‘...`);
        
        try {
            // è·å–è§†é¢‘åˆ—è¡¨
            const videoList = await getVideoList(cookie);
            if (!videoList || videoList.length === 0) {
                $.log(`è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥ï¼Œè·³è¿‡æ­¤æ¬¡è§‚çœ‹`);
                continue;
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªè§†é¢‘
            const randomVideo = videoList[Math.floor(Math.random() * videoList.length)];
            
            // æ¨¡æ‹Ÿè§‚çœ‹è§†é¢‘
            const watchResult = await watchVideo(cookie, randomVideo);
            if (watchResult.success) {
                totalRewards += watchResult.reward;
                $.log(`è§‚çœ‹å®Œæˆï¼Œè·å¾— ${watchResult.reward} é‡‘å¸`);
            } else {
                $.log(`è§‚çœ‹å¤±è´¥: ${watchResult.message}`);
            }
        } catch (error) {
            $.log(`è§‚çœ‹è§†é¢‘æ—¶å‡ºé”™: ${error.message}`);
        }
        
        // éšæœºç­‰å¾…ï¼Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·
        await randomWait(config.taskConfig.watchVideoInterval);
    }
    
    return totalRewards;
}

// è·å–è§†é¢‘åˆ—è¡¨
async function getVideoList(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/feed/hot',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                count: 20,
                pcursor: '',
                type: 7,
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1 && response.data.feeds && response.data.feeds.length > 0) {
            return response.data.feeds.map(feed => ({
                videoId: feed.photo.id,
                duration: feed.photo.duration || 15
            }));
        }
        return [];
    } catch (error) {
        $.log(`è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥: ${error.message}`);
        return [];
    }
}

// è§‚çœ‹å•ä¸ªè§†é¢‘
async function watchVideo(cookie, video) {
    try {
        // éšæœºè§‚çœ‹æ—¶é—´
        const watchTime = Math.min(video.duration, Math.floor(Math.random() * 15) + 10);
        
        const options = await generateRequestOptions({
            url: '/rest/n/video/task/reward',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                videoId: video.videoId,
                watchTime: watchTime,
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1) {
            return {
                success: true,
                reward: response.data.rewardCoins || 0
            };
        } else {
            return {
                success: false,
                message: response.data.error_msg || 'æœªçŸ¥é”™è¯¯'
            };
        }
    } catch (error) {
        return {
            success: false,
            message: error.message || 'è¯·æ±‚å¼‚å¸¸'
        };
    }
}

// å¼€å®ç®±
async function openBoxes(cookie, count) {
    let totalRewards = 0;
    
    for (let i = 1; i <= count; i++) {
        $.log(`æ­£åœ¨å¼€ç¬¬ ${i}/${count} ä¸ªå®ç®±...`);
        
        try {
            // æ£€æŸ¥å®ç®±çŠ¶æ€
            const boxStatus = await checkBoxStatus(cookie);
            if (!boxStatus.canOpen) {
                $.log(`å®ç®±æš‚æ—¶æ— æ³•å¼€å¯: ${boxStatus.message || 'æœªçŸ¥åŸå› '}`);
                break;
            }
            
            // å¼€å®ç®±
            const openResult = await openBox(cookie);
            if (openResult.success) {
                totalRewards += openResult.reward;
                $.log(`å®ç®±å¼€å¯æˆåŠŸï¼Œè·å¾— ${openResult.reward} é‡‘å¸`);
            } else {
                $.log(`å®ç®±å¼€å¯å¤±è´¥: ${openResult.message}`);
            }
        } catch (error) {
            $.log(`å¼€å®ç®±æ—¶å‡ºé”™: ${error.message}`);
        }
        
        // éšæœºç­‰å¾…
        await randomWait();
    }
    
    return totalRewards;
}

// æ£€æŸ¥å®ç®±çŠ¶æ€
async function checkBoxStatus(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/task/treasureBox/status',
            method: 'GET',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1) {
            return {
                canOpen: response.data.canOpen || false,
                message: response.data.message
            };
        }
        return { canOpen: false, message: 'è·å–å®ç®±çŠ¶æ€å¤±è´¥' };
    } catch (error) {
        return { canOpen: false, message: error.message || 'è¯·æ±‚å¼‚å¸¸' };
    }
}

// å¼€å®ç®±
async function openBox(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/task/treasureBox/open',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1) {
            return {
                success: true,
                reward: response.data.rewardCoins || 0
            };
        } else {
            return {
                success: false,
                message: response.data.error_msg || 'æœªçŸ¥é”™è¯¯'
            };
        }
    } catch (error) {
        return {
            success: false,
            message: error.message || 'è¯·æ±‚å¼‚å¸¸'
        };
    }
}

// çœ‹å¹¿å‘Š
async function watchAds(cookie, count) {
    let totalRewards = 0;
    
    for (let i = 1; i <= count; i++) {
        $.log(`æ­£åœ¨è§‚çœ‹ç¬¬ ${i}/${count} ä¸ªå¹¿å‘Š...`);
        
        try {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯è§‚çœ‹çš„å¹¿å‘Š
            const adAvailable = await checkAdAvailability(cookie);
            if (!adAvailable) {
                $.log(`æ²¡æœ‰å¯è§‚çœ‹çš„å¹¿å‘Šï¼Œè·³è¿‡`);
                break;
            }
            
            // è·å–å¹¿å‘Šåˆ—è¡¨
            const adList = await getAdList(cookie);
            if (!adList || adList.length === 0) {
                $.log(`è·å–å¹¿å‘Šåˆ—è¡¨å¤±è´¥ï¼Œè·³è¿‡æ­¤æ¬¡è§‚çœ‹`);
                continue;
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªå¹¿å‘Š
            const randomAd = adList[Math.floor(Math.random() * adList.length)];
            
            // è§‚çœ‹å¹¿å‘Š
            const watchResult = await watchAd(cookie, randomAd);
            if (watchResult.success) {
                totalRewards += watchResult.reward;
                $.log(`å¹¿å‘Šè§‚çœ‹å®Œæˆï¼Œè·å¾— ${watchResult.reward} é‡‘å¸`);
            } else {
                $.log(`å¹¿å‘Šè§‚çœ‹å¤±è´¥: ${watchResult.message}`);
            }
        } catch (error) {
            $.log(`è§‚çœ‹å¹¿å‘Šæ—¶å‡ºé”™: ${error.message}`);
        }
        
        // éšæœºç­‰å¾…ï¼Œæ¨¡æ‹ŸçœŸå®ç”¨æˆ·è§‚çœ‹å¹¿å‘Šåçš„æ“ä½œ
        await randomWait(config.taskConfig.watchVideoInterval * 2);
    }
    
    return totalRewards;
}

// æ£€æŸ¥æ˜¯å¦æœ‰å¯è§‚çœ‹çš„å¹¿å‘Š
async function checkAdAvailability(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/activity/task/ad/availability',
            method: 'GET',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            }
        });
        
        const response = await $.axios(options);
        return response.data.result === 1 && response.data.available;
    } catch (error) {
        $.log(`æ£€æŸ¥å¹¿å‘Šå¯ç”¨æ€§å¤±è´¥: ${error.message}`);
        return false;
    }
}

// è·å–å¹¿å‘Šåˆ—è¡¨
async function getAdList(cookie) {
    try {
        const options = await generateRequestOptions({
            url: '/rest/n/activity/task/ad/list',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(options);
        if (response.data.result === 1 && response.data.ads && response.data.ads.length > 0) {
            return response.data.ads.map(ad => ({
                adId: ad.adId,
                duration: ad.duration || 30,
                rewardCoins: ad.rewardCoins || 0
            }));
        }
        return [];
    } catch (error) {
        $.log(`è·å–å¹¿å‘Šåˆ—è¡¨å¤±è´¥: ${error.message}`);
        return [];
    }
}

// è§‚çœ‹å•ä¸ªå¹¿å‘Š
async function watchAd(cookie, ad) {
    try {
        // è®°å½•å¹¿å‘Šå¼€å§‹è§‚çœ‹
        const startOptions = await generateRequestOptions({
            url: '/rest/n/activity/task/ad/start',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                adId: ad.adId,
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        await $.axios(startOptions);
        
        // æ¨¡æ‹Ÿè§‚çœ‹å¹¿å‘Š
        await randomWait(ad.duration * 1000);
        
        // è®°å½•å¹¿å‘Šè§‚çœ‹å®Œæˆ
        const finishOptions = await generateRequestOptions({
            url: '/rest/n/activity/task/ad/finish',
            method: 'POST',
            headers: {
                'Cookie': cookie,
                'Referer': 'https://live.kuaishou.com/',
                'Accept': 'application/json, text/plain, */*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Content-Type': 'application/json',
                'Origin': 'https://live.kuaishou.com'
            },
            data: {
                adId: ad.adId,
                watchTime: ad.duration,
                version: apiConfig.version,
                os: apiConfig.os,
                deviceId: apiConfig.deviceId
            }
        });
        
        const response = await $.axios(finishOptions);
        if (response.data.result === 1) {
            return {
                success: true,
                reward: response.data.rewardCoins || ad.rewardCoins || 0
            };
        } else {
            return {
                success: false,
                message: response.data.error_msg || 'æœªçŸ¥é”™è¯¯'
            };
        }
    } catch (error) {
        return {
            success: false,
            message: error.message || 'è¯·æ±‚å¼‚å¸¸'
        };
    }
}

// ç”Ÿæˆè¯·æ±‚é€‰é¡¹ï¼ˆåŒ…å«ç­¾åï¼‰
async function generateRequestOptions(options) {
    // åˆå¹¶åŸºç¡€URL
    options.url = apiConfig.baseUrl + options.url;
    
    // æ·»åŠ é€šç”¨è¯·æ±‚å¤´
    options.headers = {
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0.3 Mobile/15E148 Safari/604.1',
        ...options.headers
    };
    
    // ç”Ÿæˆç­¾å
    const timestamp = Date.now();
    const nonce = Math.random().toString(36).substr(2, 10);
    
    // å‡†å¤‡ç­¾åæ•°æ®
    let signData = {
        timestamp,
        nonce,
        version: apiConfig.version,
        os: apiConfig.os,
        deviceId: apiConfig.deviceId
    };
    
    // å¦‚æœæœ‰è¯·æ±‚æ•°æ®ï¼ŒåŠ å…¥ç­¾å
    if (options.data) {
        signData = { ...signData, ...options.data };
    }
    
    // ç”Ÿæˆç­¾åï¼ˆè¿™é‡Œä½¿ç”¨ç®€åŒ–ç‰ˆï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç­¾åç®—æ³•ï¼‰
    const sign = generateSign(signData);
    
    // æ·»åŠ ç­¾åç›¸å…³å‚æ•°åˆ°è¯·æ±‚å¤´æˆ–æ•°æ®
    if (options.method === 'GET') {
        // å¯¹äºGETè¯·æ±‚ï¼Œæ·»åŠ åˆ°URLå‚æ•°
        const queryString = new URLSearchParams({ ...signData, sign }).toString();
        options.url += (options.url.includes('?') ? '&' : '?') + queryString;
    } else {
        // å¯¹äºPOSTè¯·æ±‚ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä½“
        options.data = { ...options.data, timestamp, nonce, sign };
    }
    
    return options;
}

// ç”Ÿæˆç­¾åï¼ˆç®€åŒ–ç‰ˆï¼‰
function generateSign(data) {
    // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç­¾åç®—æ³•
    // è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹ï¼Œå°†æ‰€æœ‰å‚æ•°æŒ‰å­—æ¯æ’åºåæ‹¼æ¥ï¼Œå†åŠ ä¸Šå¯†é’¥ï¼Œæœ€åMD5
    const sortedKeys = Object.keys(data).sort();
    let signStr = '';
    
    sortedKeys.forEach(key => {
        signStr += `${key}=${data[key]}&`;
    });
    
    // æ·»åŠ å¯†é’¥ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»é…ç½®æˆ–ç¯å¢ƒå˜é‡è·å–ï¼‰
    signStr += 'your_secret_key';
    
    // ç®€å•çš„å“ˆå¸Œå¤„ç†ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨MD5æˆ–SHA-256ç­‰ï¼‰
    let hash = 0;
    for (let i = 0; i < signStr.length; i++) {
        const char = signStr.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0; // Convert to 32bit integer
    }
    
    return Math.abs(hash).toString(16);
}

// æ£€æŸ¥è„šæœ¬æ›´æ–°
async function checkScriptUpdate() {
    try {
        // æ£€æŸ¥ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        const lastUpdateTime = await getLastUpdateTime();
        const now = Date.now();
        
        // å¦‚æœè·ç¦»ä¸Šæ¬¡æ£€æŸ¥ä¸è¶³è®¾å®šçš„é—´éš”æ—¶é—´ï¼Œåˆ™ä¸æ£€æŸ¥
        if (now - lastUpdateTime < config.autoUpdate.checkInterval) {
            $.log(`è·ç¦»ä¸Šæ¬¡æ£€æŸ¥æ›´æ–°æ—¶é—´ä¸è¶³ï¼Œè·³è¿‡æ›´æ–°æ£€æŸ¥`);
            return;
        }
        
        $.log(`å¼€å§‹æ£€æŸ¥è„šæœ¬æ›´æ–°...`);
        
        // è·å–æœ€æ–°è„šæœ¬
        const options = {
            url: config.autoUpdate.repoUrl,
            method: 'GET',
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
            }
        };
        
        const response = await $.axios(options);
        const latestScript = response.data;
        
        // è¯»å–å½“å‰è„šæœ¬
        const currentScript = fs.readFileSync(config.autoUpdate.localPath, 'utf8');
        
        // æ¯”è¾ƒè„šæœ¬å†…å®¹
        if (latestScript !== currentScript) {
            $.log(`å‘ç°æ–°ç‰ˆæœ¬è„šæœ¬ï¼Œå¼€å§‹æ›´æ–°...`);
            
            // ä¿å­˜æ–°ç‰ˆæœ¬è„šæœ¬
            fs.writeFileSync(config.autoUpdate.localPath, latestScript);
            
            // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
            await saveLastUpdateTime(now);
            
            $.log(`è„šæœ¬æ›´æ–°æˆåŠŸï¼ä¸‹æ¬¡è¿è¡Œå°†ä½¿ç”¨æ–°ç‰ˆæœ¬ã€‚`);
            
            // å‘é€é€šçŸ¥
            if (notify) {
                await notify('å¿«æ‰‹æé€Ÿç‰ˆè„šæœ¬æ›´æ–°é€šçŸ¥', 'è„šæœ¬å·²è‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·ç•™æ„æ›´æ–°å†…å®¹ã€‚');
            }
        } else {
            $.log(`è„šæœ¬å·²æ˜¯æœ€æ–°ç‰ˆæœ¬`);
            
            // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
            await saveLastUpdateTime(now);
        }
    } catch (error) {
        $.log(`æ£€æŸ¥è„šæœ¬æ›´æ–°å¤±è´¥: ${error.message}`);
    }
}

// è·å–ä¸Šæ¬¡æ›´æ–°æ—¶é—´
async function getLastUpdateTime() {
    try {
        const filePath = path.join(path.dirname(config.autoUpdate.localPath), 'last_update_time.txt');
        if (fs.existsSync(filePath)) {
            const content = fs.readFileSync(filePath, 'utf8');
            return parseInt(content) || 0;
        }
        return 0;
    } catch (error) {
        return 0;
    }
}

// ä¿å­˜ä¸Šæ¬¡æ›´æ–°æ—¶é—´
async function saveLastUpdateTime(time) {
    try {
        const filePath = path.join(path.dirname(config.autoUpdate.localPath), 'last_update_time.txt');
        fs.writeFileSync(filePath, time.toString());
    } catch (error) {
        $.log(`ä¿å­˜ä¸Šæ¬¡æ›´æ–°æ—¶é—´å¤±è´¥: ${error.message}`);
    }
}

// éšæœºç”Ÿæˆè®¾å¤‡ID
function generateDeviceId() {
    return apiConfig.deviceId;
}

// éšæœºç­‰å¾…
async function randomWait(baseTime = 0) {
    const waitTime = baseTime + Math.floor(Math.random() * (config.taskConfig.maxWaitTime - config.taskConfig.minWaitTime)) + config.taskConfig.minWaitTime;
    return new Promise(resolve => setTimeout(resolve, waitTime));
}

// ä»»åŠ¡æ€»ç»“
async function summary() {
    $.log(`\n===== ä»»åŠ¡æ€»ç»“ =====`);
    $.log(`å…±å¤„ç† ${config.cookies.length} ä¸ªè´¦å·`);
    $.log(`æ€»é‡‘å¸æ•°: ${totalPoints}`);
    $.log(`ä»Šæ—¥èµšå–é‡‘å¸: ${todayEarnedPoints}`);
    
    if (isFirstLogin) {
        $.log(`ğŸ‰ ä»Šæ—¥é¦–æ¬¡ç™»å½•ï¼Œè·å¾—é¢å¤–å¥–åŠ±!`);
    }
}

// å‘é€é€šçŸ¥
async function notifyResult() {
    if (!notify) return;
    
    const title = 'å¿«æ‰‹æé€Ÿç‰ˆä»»åŠ¡å®Œæˆ';
    let message = `å…±å¤„ç† ${config.cookies.length} ä¸ªè´¦å·\n`;
    message += `æ€»é‡‘å¸æ•°: ${totalPoints}\n`;
    message += `ä»Šæ—¥èµšå–é‡‘å¸: ${todayEarnedPoints}\n`;
    
    if (isFirstLogin) {
        message += `ğŸ‰ ä»Šæ—¥é¦–æ¬¡ç™»å½•ï¼Œè·å¾—é¢å¤–å¥–åŠ±!\n`;
    }
    
    await notify(title, message);
}

// ç¯å¢ƒç±»ï¼Œå…¼å®¹Nodeå’ŒJavaScript
class Env {
    constructor(name) {
        this.name = name;
        this.isNode = typeof module !== 'undefined' && module.exports;
        this.logs = [];
    }
    
    log(...args) {
        const log = args.join(' ');
        console.log(log);
        this.logs.push(log);
    }
    
    error(...args) {
        const log = args.join(' ');
        console.error(log);
        this.logs.push(log);
    }
    
    done() {
        console.log(`\n${this.name} ä»»åŠ¡æ‰§è¡Œå®Œæ¯•`);
    }
    
    axios(options) {
        if (this.isNode) {
            return require('axios')(options);
        } else {
            return fetch(options.url, {
                method: options.method || 'GET',
                headers: options.headers,
                body: options.data ? JSON.stringify(options.data) : undefined
            }).then(res => res.json());
        }
    }
}

// æ‰§è¡Œä¸»å‡½æ•°
main().catch(error => {
    $.log(`æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
    $.done();
});    
